# Interactive-Panopticon
本游戏基于英国哲学家边沁提出的“全景监狱/圆形监狱”概念，使用Blender和C4D进行建模，Unity完成交互功能落地。实验过程如下：
# 一 实验要求
1. 自定一个虚拟应用场景主题
2. 通过软件建模或者网上下载模型的方式对场景里的模型进行构建（要求至少有两个模型是通过软件建模）
3. 使用 Unity3D 将所创建模型组成一个虚拟场景，包括声音等。
4. 在虚拟场景里实现简单的交互
5. 使用 VR 头盔实现虚拟场景漫游
6. 提交模型、Unity 工程文件夹、视频录屏、实验报告
# 二 实验设备
blender，unity，c4d
# 三 实验目标
 本次实验选题为建造福柯的全景式监狱建筑，灵感来源于福柯的《惩罚与规训》，名词来源于边沁，监狱呈圆形，所有囚室对着中央监视塔，监视塔里的看守对囚徒的活动一览无遗。而囚犯并不知道此时有没有人在监视他，从而达到一种很好的监视效果。本次实验构想为模拟一个监狱长的视角，建筑上建造一个 4×25 的圆形监狱主体，中间放置一座三层瞭望塔，设置电梯上下楼梯，有行走、躺下、坐电梯、开灯、警报器等
多种交互功能。
# 四 实验步骤
## 3.1 瞭望塔建模
首先新建八棱柱，在需要挖空的区域建立适当大小的立方体。将立方体组设为主体布尔
的对象，从中部挖空并为底部添加地面。
新建八棱柱，通过挤出+缩放的方式建立屋顶模型。
同样的方式建立顶部阁楼和塔身。
建立探照灯。
灯芯细节。
瞭望塔一层外侧栈道建模。主要分为：横向扶手、纵向扶手和顶部球型装饰。
### 3.1.2 材质
Blender 材质自定义功能十分完善，因此选择充分探索软件自身功能而非直接找材质资源。
#### 3.1.2.1 瞭望塔墙壁——砖块
首先为瞭望塔主体外墙添加砖块材质。主要分为三部分：（1）石块；（2）石缝间的泥
土；（3）缝隙中的苔藓。
首先塑造石块效果。新建 Voronoi Texture，将 randomness 设为 0.2，为石块添加不规则效果，同时调整 Scale 使石块大小适应塔的大小。由于塔楼 Z 轴放大大于 X、Y 轴，
因此需要对贴图进行 Z 轴方向的调整。添加 Mapping 节点解决变形问题。
新建 Noise Texture 并与 VoronoiTexture 通过 Darken 节点混合，在叠加的基础上加
深，模拟岩石受风化、侵蚀等作用销蚀缺损的效果。
由于对比不明显会造成后期生成凹凸时落差过小，影响视觉效果，添加 Colormap 节点
缩放灰度范围，得到下图对比度明显的灰度贴图。
将 Colormap 连接到 PrincipalBSDF 节点并查看石砖建模效果。
下面对石缝中的泥土进行建模。基本操作步骤同上。由于泥土颜色为棕色，因此在
Colormap 节点中调整颜色范围两端RGB 为深棕色和浅棕色。除此之外还要添加 bump
节点实现凹凸效果，根据实际需要调整强度。
最后一步是添加石头上的苔藓，先新建 Noise Texture 节点随机生成苔藓位置，再使用
Colormap 节点添加绿色。泥土与苔藓的结合效果如下：
最终使用 Mix Shader 节点将石块与泥土苔藓结合，得到下图塔楼外墙。
塔楼的所有着色器节点网格如下图：
#### 3.1.2.2 瞭望塔栈道——金属围栏和支架
为栈道的扶手和围栏添加材质。为贴合监狱粗犷的风格，我们使用粗糙、有颗粒感的金
属材质而非光滑的不锈钢。首先使用 Musgrave Texture 生成分形噪声，相较于普通的
noise texture，马氏分形纹理算法产生了平滑的奶牛花纹般的白色斑点。它们的中心
比边缘更亮，类似于海洋中的山的高度图。同时具有多种模式可供选择。
先使用马氏分型纹理
新建 noise texture，增加真实性。
由于对比度太小，添加 coloramp 调节颜色范围，增强对比度。
使用混合 rgb 将噪声纹理和马氏分型混合，模式使用加深（Darken）。
由于颜色太深，使用 colormap 调节灰度范围和最深、最浅的颜色边界。
为实现仿真效果，添加 bump 模拟生锈造成的突起。适当起伏调节强度。
最终效果如下图所示：
材质着色器节点网络如下图所示：
金属支架和扶手的材质十分相似，只是简单地修改了连接到 Base Color 的 Colormap
使金属的颜色更深，因此不再赘述制作过程，仅在下方贴出最终效果。
#### 3.1.2.3 瞭望塔栈道——地面
地面主要分为两部分：室内木地板和室外水泥地，其中室外水泥地还包括一个模拟仿真
露出钢筋的金属混凝土边框。
添加 Brick Texture 节点并调节参数，得到如下图所示的地面材质。
### 3.1.4 素材导入
场景中部分家具来自网络资源，下载 fbx 格式模型及 texture，新建 material 并将图片
填入对应位置。下图为部分材质贴图配置展示和材质贴图文件。
将 blender 模型导入 unity，有材质丢失的问题。
使用将 texture 资源图片单独导出并在 unity 中新建 material 将图片填入对应位置解决
问题。以下为瞭望塔导入 unity 后的部分细节及整体效果截图展示：
## 3.2 牢房建模
### 3.2.1 主体建模
 首先使用一个圆盘作为底部，用一个管道作为墙的主体，用圆环面作为每层的间隔，
调整内外半径和高度宽度，再放置一个长方体再作为竖着的间隔，用阵列克隆出 25 个
隔层，总共将监狱主体分割为 3×26 个小隔间。
再优化相关细节如对横竖隔层边角进行倒角，使得更加自然圆滑和真实。
### 3.2.2 围栏以及门建模
 对于每层的横间隔部分，将内侧半径加长，制作一个走廊区域，需要设置一圈围栏。
用圆柱体在合适的地方排列后进行阵列克隆，围栏扶手是使用一个圆环面直接缩小制成。
再将其复制四层，在每一层放置即可。
 每个监狱小房间需要有一个铁栏杆门，同样使用圆柱的排列来构成那种监狱的风格的
门，由于需要考虑开门关门的交互，专门留出一个门的部分做一个单独的门可供旋转开
关的。再将门框通过阵列克隆出 4×26 个，移动排列。
对于监狱的小门，参考网图之后先建一个框，再用圆柱栏杆补充上下镂空区域。
 再使用阵列克隆一圈 25 个，在门的克隆中出现了一些问题，由于我在旋转门的时候
为了方便，把物体的轴心居中到了对象上，导致在克隆的时候它并不是绕着中轴心旋转
的，有一定的偏差，导致没有办法准确的嵌在门框里，最后通过调整轴心移动到世界坐
标零点，使克隆的成为一个圆形。
 由于阵列克隆的原因，在每一个部分都有小门放置，但在大门的部分不需要这个小门，
所以需要将这个阵列转化为可编辑对象之后，删除掉其中不需要的即可。在大门外面的
位置，用立方体搭一个门框，做个倒角。监狱大门仍然使用栏杆形式，不同的是大门比
较宽，需要实现一个双开门的效果，参考了网图之后，决定分成左右两个部分来做，复
制栏杆，在最中间的位置放置两个闭合的长方体将两扇门分开，这样就可以单独旋转开
合一扇门了。
### 3.2.3.窗建模
 考虑到监狱需要有窗户透光，使用长方体来制作最简单的窗户，用立方体作为窗框，
两个立方体在左右通过布尔减法来打出窗户玻璃的空缺处，就可以打出窗户的轮廓，但
是由于窗户是嵌在外墙上的，也得对外墙同时做布尔减，同时对窗户做阵列克隆时，由
于外墙在子物体中，导致外墙也同时被克隆了很多份，所以不能这样，只能通过先对窗
框和窗体阵列克隆之后打组转化成编辑对象再一次性对外墙布尔减，就可以打出四层窗
户了。再对窗玻璃赋予它玻璃材质。
### 3.2.4.顶建模
 监狱的顶部采用一个圆环面来处理，加好几层线圈之后在点层级对点进行处理，一层
一层调整点的位置，先将外沿三层点逐级向上拉，再将内层分别向下和向上拉，由于当
时旋转分段设置的太多，导致太过圆滑，但不想再重新做了，就多加了些点让它更尖锐
一点。
除了形状，还设置了一个顶部透光的玻璃窗结构，在顶部放置一圈克隆好的立方体之
后，对顶做布尔减，将镂空部分抠出来，复制一个立方体克隆结构调整厚度作为玻璃片。
### 3.2.5.楼梯建模
对建筑而言，需要一个楼梯来从一层到达二三四层的监狱，为了不占用有限的监狱
内部容量，选择将楼梯嵌在监狱隔间内部，放置在进大门的右手边的三层处，由于当时
对底层隔层的分段不到位，导致没有办法完美的将不需要的这一间单独空出来，只能采
用布尔减将不要的地方除去，但是这个隔间并不是个标准的立方体，有一定的弧度，所
以退而求其次，将需要用的地方作为一个标准的立方体抠掉。本来想做一个螺旋上升的
楼梯，但这个结构实在有点特殊，没办法中途到达二三层，于是采用一层一层的分隔开
的螺旋楼梯，每层之间调整旋转宽度去构建，会容易一些。先放置一个立方体和两个圆
柱体作为一层楼梯，用克隆变形器，调整旋转角度和半径，实现旋转楼梯效果，由于二
三层的角度不同所以需要重新调整。
 对于楼梯扶手来说，使用了一个新的工具追踪对象，先将楼梯的克隆复制两份，将内
容删掉并将空对象改成球形模式，调整克隆中的变换参数，将球体放置在楼梯圆柱的顶
端，在追踪对象中对两个克隆进行连接追踪，使用贝塞尔模式，就可以得到平滑的楼梯
扶手了。
### 3.2.6.场景完善
 在每个房间中放置马桶、床和壁灯等物品，克隆到每一个房间中，在克隆床的时候，
由于导入的模型自身的坐标轴和世界坐标轴不一样，克隆后方向不一样，还是需要调整
坐标轴方向。阵列还是比克隆要好做一些，克隆不受坐标轴的影响，但克隆无法控制旋
转的位置。
### 3.2.7.材质准备
 搜索各种不同的材质球贴图，在 c4d 中创建相应的材质球，并赋予各种物品，贴图
在贴的时候需要注意大小调节，避免贴图变形。
 在导入 unity 时，需要先将贴图文件夹拖入 unity 文件夹，就可以自动对上，但比如
金属材质，添加新的 ggx 层后，拖入 unity 之后金属材质会消失，需要在预制体材质中
直接更改材质球，在 unity 中新建材质球。另外贴图材质球需要将各个层对应的不同贴
图导入不同层，合并之后可以达到一个很好的效果。
### 3.2.8.电梯按钮制作
 由于找不到合适的模型，选择自己做，用几个圆柱体，通过面的处理，加一些细节，
对于电梯按钮，让它面内陷，对于警报器按钮，让中间红色按钮的位置外凸，再使用倒
角让边角过度更自然完善。
 上下按钮用三角形替代，数字通过加 text 文本，再添加材质即可。
## 3.3 交互
### 3.3.1 人物状态
 移动：按 WASD 键即可移动
 旋转：点击鼠标右键进行拖拽即可实现左右视角的移动。
 躺下：靠近床时点击床即可躺下。
 站立：躺下后点击 G 键即可站立。
### 3.3.2 电梯
 整体逻辑：按键后接收信息存入数组中，两数组分别记录当前层数和移动数，目标
层和列表层，当电梯到达某层后将当前层从列表层中移出。如果该楼层被激活且是同方
向，则进行位置校正并执行开门，同时添加层数或删除层数。根据第一次点击的楼层，
以及上下键确定移动方向。检测所有门处于关闭状态后踏板按照一定速度移动至最先按
的楼层，按照被按的先后顺序确定上下移动顺序，由踏板的升降带动人物的升降。每次
到达楼层后打开关闭电梯门后都要检测所有门的关闭状态。
### 3.3.3 楼梯
#### 3.3.3.1 自动寻路
 启用 unityAI 中的 Navigation 自动寻路系统，对角色添加 Nav Agent 挂件，将地
面和平面设置为 static，然后进行 bake，即可实现目标自动到达点击处。
 思路一：通过直接修改 Navigation 中的爬坡参数，使角色点击即可上楼梯。
 局限性：坡的高度有限制，不能实现多级台阶的跨越。
 思路二：创建两个空物体并挂载 Off Mesh Link 组件，同时将其分别设为起点与终
点，放在每一级台阶上，即可直接跨越。
 局限性：台阶太小在系统预先烘焙时会被认定为障碍物而非平面，而楼梯大小本身有
限，故不能达到预期效果。
#### 3.3.3.2 碰撞检测
 Navigation 不能实现爬楼梯效果后，我又尝试了碰撞检测爬楼梯。即当角色检测碰
撞到楼梯时改变物体位置。但是当角色跨到第一级台阶后，由于本身一直在与第一级台
阶碰撞，导致无法检测第二级台阶，因此未能成功实现。
### 3.3.4 开灯
思路：创建脚本，调用 setActive（）函数设置所挂物体的开关状态，即可实现开关灯。
将每一层的所有灯光作为一个灯光的物体，即可实现一键开关一层楼的灯的效果。同时
在开关处选择了电闸的形式，点击对应的闸门配合拉闸的动作即可关闭相应楼层的灯，
更贴近现实生活。
### 3.3.5 开门
思路一：碰撞检测开门
创建空物体置于门边位置作为门的旋转轴，将门作为其子物体。再创建空物体作为检测
区域，添加 boxcollider 设置为 trigger，只有当角色进入检测区域并按 F 键时才能开
门。
思路二：射线检测开门
对鼠标点击物体进行检测，若点击的是门则将门绕固定轴进行旋转。
### 3.3.6 警报器
创建一个自发光的材质球和无发光的材质球，设置主要颜色与自发光颜色，调整金属度
Metallic 与平滑度 Smoothness
使用 material 的 EnableKeyword 和 DisableKeyword 来控制_EMISSION 属性的开关
配合射线检测即可实现点击按钮触发警报器
### 3.3.7 音效
走路音效：仅有用户按 WASD 键时才会播放，停止按键则会停止播放。
电梯音效：在电梯门打开关闭时才会触发电梯开门时叮的声音以及电梯门本身开闭的声
音。
警报器音效：触发警报器后会有警报声，在警报器闪烁 5 下后停止警报。
### 3.3.8 背景介绍
 因为本次选题是一个情景式的场景，为了使场景更加完善，选择添加开始场景和一个
情景式引入文化背景，首先新创一个场景，添加 image、text 和 button 等部件，将导
入的图片素材的 type 改成 sprite2D 精灵模式，再贴在 image 的 source 上。为了使
界面没那么亮和清晰，再在 image 上叠加一层，调整它的透明度即可。
 情景设定玩家“我”是福柯全景监狱中新上任的狱长，在欢迎信中插入文化背景介
绍和功能简介，更加有沉浸感。在做这个点的时候，首先想的是用 PPT 做一个竖版的
文本截图直接导入图片，但 unity 中直接导入图片后会非常糊，再怎么调整都没用，还
是得用 unity 中的 text，text 文本同样会出现很糊的情况，需要将字号放很大，将 scale
缩小，调整位置。但字号也不能调的太大，由于文字比较多，字号过大会导致文字动态
加在失败而出 bug，只能缩小或减少字数。
 按钮交互上，可以将所有按钮的操作函数都放在一个脚本中，挂载在一个空物体上，
将函数对应的操作物体拖入相应的位置，再在 onclick 操作面板上添加对应的函数操作
即可。
 在玩家阅读完欢迎信后点击“好的”按钮，通过在按钮上挂载脚本，点击后切换到漫
游主场景。
### 3.3.9 犯人模型
 为了让监狱更真实更充实，在 unity 官方资源商店里找合适的模型，并导入工程文件
中，给模型挂载对应的动画控制器组件，使人物模型处在一个 idle 的状态，比较真实。
总共复制了十份人物角色在场景中。
### 3.3.10 整合
将创建好的模型导入到 unity 中，将之前实现的交互与模型相结合。
电梯的适应问题：由于电梯预先完成，只能进行纵向缩放无法进行横向缩放，故需要瞭
望塔和监狱的整体缩放和不断调整。同时电梯踏板和瞭望塔平面的高度必须保持一致，
否则人物行进会受阻碍，容易产生卡住或者掉落的情况。且调试过程需要不断模拟整个
过程，非常耗费时间。
碰撞体的添加：由于监狱形状的特殊性，对于碰撞体的添加采用了多个 boxcollider 叠
加的方法。
探照灯：在给探照灯添加聚光灯光源时，无法辨别光源的具体位置和照射方向，难以达
到预期效果。
灯光问题：模型导入进来后部分材质有所变化，灯光置景需要重新调整。
由于建模时物体的细化，导致导入后物体量非常庞大，命名也较为杂乱，对于整体位
置的把控要求较高，同时在寻找物体的过程中耗费大量时间。
## 3.4 布光
作为全景敞视监狱中非常重要的一环，瞭望塔的探照灯是实现“一人监视全监狱”的关
键点。由于 unity 中自带的四种灯光体积感都不能达到我们的要求，因此找到了 unity
官方在 github 上发布的一个库 GitHub - Unity-Technologies/VolumetricLighting: 
Lighting effects implemented for the Adam demo: volumetric fog, area lights 
and tube lights。其中的 area light 可以模拟射灯的效果，导入 unity 中简单改变参数调试。
# 四 问题
1. 由于纵向扶手的 Z 轴拉伸过大，在将纵向柱体围栏和顶部球体同时贴图的时候出现
围栏贴图被拉伸失真的现象。通过对柱体围栏的材质添加 Mapping 节点调整
TextureZ 轴缩放解决问题。
2. 为屋顶添加材质时由于具有弧度，所以直接贴图会出现以下不符合实际情况的效果。
展 UV 后由于屋檐平面为梯形，贴图会出现下宽上窄的问题。
通过对 UV 展开图中的节点进行缩放解决问题。
3.在最终整合时发现点击响应的脚本失效。由于文件在添加灯光的过程中经过生成为预
制体、复制粘贴进新场景等操作，原来能正常运行的点击响应事件没有被触发。我们对
Debug 输出信息进行查看，发现能检测到碰撞物体并输出名称的函数并非来自于我们
出现问题的脚本。由此可知不是脚本内语句的执行问题，而是脚本本身没有被调用。
因此检查挂载脚本的对象属性信息，发现没有挂上对应脚本，重新挂载解决问题。
五 心得总结
1. 材质贴图：熟悉 blender 着色器中常用节点。在本次实验中使用材质贴图和节点自
定义两种方法赋予物体材质。明确了材质贴图方式中实现物体表面立体效果的两种
方式：一，使用 bump(凹凸)实现光影效果下的立体，这种方式只是视觉效果上的
凹凸，事实上物体表面仍属于同一平面；二，使用 displace（置换）根据灰度图中
颜色深浅改变平面上各点法向量，这是真正意义上的立体，但当物体细分较多时，
这种方式会使渲染速度变慢。
2. 熟悉掌握 c4d 中阵列、克隆等变形器的使用，明白二者之间主要的区别，能够在不
同需求中选择合适的方法来处理，对轴的操作理解更深刻了，变换坐标轴和调整轴
心等。学习了追踪对象的使用，通过虚拟现实这门课确实提高了建模能力，训练了
建模的逻辑性和具象性思维，能够在需求层面达到比较好的效果。
3. 由于虚拟漫游需要实现沉浸感，对于各个物体及建筑的大小和布局方面有了一定的
理解，离“虚拟现实”更近了一步。
4. 对 unity 中 UI 操作更熟悉了，能够失恋掌握文本和图片等的交互编辑，掌握了各
种快捷键如按 f 快速移动视角，ctrl+shift+f 锁定相机视角到现在视窗等。
5. 通过本次实验，提高了完成项目的能力和团队协作配合的能力，希望在后续作业和
项目中吸取经验，更好的完成和安排工作。
6. 对于庞杂的模型和物体信息的处理、整合能力有所提高。
